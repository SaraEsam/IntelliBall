!pip install ultralytics deep_sort_realtime filterpy torch torchvision gradio nupmy
import cv2
import numpy as np
import torch
from ultralytics import YOLO
from deep_sort_realtime.deepsort_tracker import DeepSort
import gradio as gr
from collections import deque
import tempfile

model = YOLO("yolov8x.pt")
tracker = DeepSort(max_age=30)

def analyze_offside(video_path):
    cap = cv2.VideoCapture(video_path)
    width, height = int(cap.get(3)), int(cap.get(4))
    fps = int(cap.get(5))

    temp_output = tempfile.NamedTemporaryFile(suffix=".mp4", delete=False)
    out = cv2.VideoWriter(temp_output.name, cv2.VideoWriter_fourcc(*"mp4v"), fps, (width, height))

    ball_history = deque(maxlen=10)
    frame_buffer = deque(maxlen=10)
    pass_frame = None
    offside_result = "âŒ Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù„Ø­Ø¸Ø© ØªÙ…Ø±ÙŠØ± ÙˆØ§Ø¶Ø­Ø©."
    decision_made = False

    players_at_pass = []

    while cap.isOpened():
        ret, frame = cap.read()
        if not ret:
            break

        frame_buffer.append(frame.copy())

        results = model(frame)[0]
        detections = []
        ball_pos = None
        players = []

        for result in results.boxes.data:
            x1, y1, x2, y2, conf, cls = result.cpu().numpy()
            class_id = int(cls)
            if class_id == 0:  # Player
                detections.append(([x1, y1, x2, y2], conf, class_id))
            elif class_id == 32:  # Ball
                ball_pos = (int((x1 + x2) / 2), int((y1 + y2) / 2))

        # ØªØªØ¨Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
        tracks = tracker.update_tracks(detections, frame=frame)
        for track in tracks:
            if track.is_confirmed() and track.time_since_update == 0:
                track_id = track.track_id
                ltrb = track.to_ltrb()
                players.append((track_id, *ltrb))

        ball_history.append(ball_pos)

        if not decision_made and len(ball_history) >= 5:
            prev = ball_history[-5]
            curr = ball_history[-1]
            if prev and curr:
                dx = curr[0] - prev[0]
                dy = curr[1] - prev[1]
                dist = np.sqrt(dx ** 2 + dy ** 2)

                if dist > 10:
                    pass_frame = frame_buffer[-6]  # Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø±Ùƒ
                    players_at_pass = players.copy()

                    if len(players_at_pass) >= 3:
                        # Ù†Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù…Ø±Ù…Ù‰ (x=0) Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
                        players_sorted = sorted(players_at_pass, key=lambda p: p[1])  # by x1
                        last_two_defenders = players_sorted[:2]  # Ø£Ù‚Ø±Ø¨ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„Ù…Ø±Ù…Ù‰
                        farthest_attacker = players_sorted[-1]  # Ø£Ø¨Ø¹Ø¯ Ù…Ù‡Ø§Ø¬Ù…

                        second_last_defender_x = max(last_two_defenders[0][1], last_two_defenders[1][1])
                        attacker_x = farthest_attacker[1]

                        offside = attacker_x < second_last_defender_x  # Ø£Ù‚Ø±Ø¨ Ù„Ù„Ù…Ø±Ù…Ù‰

                        label = "Offside!" if offside else "Not Offside"
                        color = (0, 0, 255) if offside else (0, 255, 0)
                        cv2.putText(pass_frame, label, (50, 60), cv2.FONT_HERSHEY_SIMPLEX, 1.5, color, 3)

                        # Ø±Ø³Ù… Ø§Ù„Ø®Ø· Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¯Ø§ÙØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ
                        cv2.line(pass_frame, (int(second_last_defender_x), 0), (int(second_last_defender_x), height), color, 2)

                        for _ in range(30):  # 1 Ø«Ø§Ù†ÙŠØ©
                            out.write(pass_frame)

                        offside_result = f"âœ… Ø§Ù„Ù†ØªÙŠØ¬Ø©: {label}"
                        decision_made = True
                        continue

        out.write(frame)

    cap.release()
    out.release()
    return temp_output.name, offside_result

# Gradio GUI
def process(video):
    return analyze_offside(video)

demo = gr.Interface(
    fn=process,
    inputs=gr.Video(label="ğŸ“¥ Ø£Ø¯Ø®Ù„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªÙ…Ø±ÙŠØ±Ø©", format="mp4"),
    outputs=[gr.Video(label="ğŸ“¤ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ø§ØªØ¬"), gr.Textbox(label="âš½ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ³Ù„Ù„")],
    title="Ù†Ø¸Ø§Ù… ÙƒØ´Ù Ø§Ù„ØªØ³Ù„Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ğŸ¯",
    description="ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ù„Ø­Ø¸Ø© ØªÙ…Ø±ÙŠØ± Ø§Ù„ÙƒØ±Ø© ÙˆØ­Ø³Ø§Ø¨ ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„ØªØ³Ù„Ù„ Ø¨Ø¯Ù‚Ø© Ù„Ø­Ø¸Ø© Ù„Ù…Ø³ Ø§Ù„ÙƒØ±Ø©."
)

demo.launch()
